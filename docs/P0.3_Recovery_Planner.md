# P0.3 Recovery Planner & Executor

## Архитектура
- FastAPI + Celery (Redis broker)
- PostgreSQL для хранения шаблонов, планов и логов выполнений
- Интеграция с Knowledge Base (P0.2.6) для поиска исторических паттернов
- Поддержка Terraform CLI и Kubernetes API

## Компоненты

### RecoveryPlanner
Генерирует планы восстановления на основе шаблонов и исторических данных.

**Методы:**
- `plan_recovery(incident: Incident) -> RecoveryPlan` — создаёт план для инцидента
- `list_templates() -> List[Template]` — возвращает доступные шаблоны

### RecoveryExecutor
Выполняет планы восстановления с поддержкой rollback.

**Методы:**
- `execute(plan: RecoveryPlan) -> ExecutionResult` — запускает шаги плана

### Celery Integration
Асинхронное выполнение через Celery tasks:
```python
from celery_app import execute_plan
result = execute_plan.delay(plan.model_dump())
```

## API Endpoints

### POST /plan
Генерация плана восстановления.

**Request:**
```json
{
  "id": "incident-123",
  "timestamp": "2025-10-21T08:00:00Z",
  "severity": 0.9,
  "context": {"cpu": 95, "service": "redis"}
}
```

**Response:**
```json
{
  "id": "plan-uuid",
  "steps": ["stop_service: redis", "restore_backup: redis_backup", "start_service: redis"],
  "risk_score": 0.1
}
```

### GET /templates
Список доступных шаблонов восстановления.

**Response:**
```json
[
  {
    "id": "redis_outage",
    "name": "redis_outage",
    "description": "Plan for Redis failure",
    "steps": ["stop_service: redis", "restore_backup: redis_backup", "start_service: redis"]
  }
]
```

### POST /execute
Запуск плана восстановления.

**Request:**
```json
{
  "id": "plan-uuid",
  "steps": ["scale-out deployment"],
  "risk_score": 0.1
}
```

**Response:**
```json
{
  "success": true,
  "logs": ["Executed: scale-out deployment"]
}
```

## Модели данных (SQLAlchemy)

### Template
- `id` (int, PK)
- `name` (str, unique)
- `description` (str, nullable)
- `payload` (JSON)

### Plan
- `id` (int, PK)
- `incident_id` (str)
- `template_id` (int)
- `parameters` (JSON)
- `status` (str): pending/running/completed/failed
- `risk_score` (float)
- `created_at` (datetime)

### Execution
- `id` (int, PK)
- `plan_id` (int)
- `start_ts` (datetime)
- `end_ts` (datetime, nullable)
- `result` (JSON, nullable)
- `logs` (text, nullable)

## Поток данных
```
Incident → POST /plan → RecoveryPlanner → RAG KB (context) → RecoveryPlan
         → Celery task → RecoveryExecutor → Terraform/K8s API → ExecutionResult
         → Knowledge Base (feedback loop)
```

## Конфигурация

### config/planner_config.yaml
```yaml
celery:
  broker_url: redis://localhost:6379/0
  result_backend: redis://localhost:6379/1

templates:
  - id: redis_outage
    name: redis_outage
    description: "Plan for Redis failure"
    steps:
      - "stop_service: redis"
      - "restore_backup: redis_backup"
      - "start_service: redis"
```

## Тестирование

### Unit Tests
- `test_plan_recovery_valid_input` — проверка генерации плана
- `test_list_templates_non_empty` — проверка загрузки шаблонов
- `test_execute_success_case` — успешное выполнение
- `test_execute_failure_handling` — обработка ошибок

### Integration Tests
- `test_recovery_flow` — end-to-end тест: инцидент → план → выполнение

### Запуск тестов
```bash
source .venv/bin/activate
PYTHONPATH=src pytest -v tests/unit/p03_recovery
PYTHONPATH=src pytest -v tests/integration
```

## Метрики
- **План генерации:** время < 200ms (p95)
- **Успешность:** ≥90% first-attempt recovery
- **MTTR:** < 30s (целевой показатель)

## Как добавить новый тип action
1. Добавьте шаблон в `config/planner_config.yaml`:
   ```yaml
   - id: new_action
     name: new_action
     description: "Description"
     steps:
       - "step 1"
       - "step 2"
   ```
2. Реализуйте обработку в `RecoveryExecutor.execute()` при необходимости
3. Добавьте unit-тест в `tests/unit/p03_recovery/`
4. Запустите `pytest` для верификации

## CI/CD
GitHub Actions workflow: `.github/workflows/ci.yml`
- Линтинг (flake8)
- Type checking (mypy)
- Unit и integration tests
- Coverage reporting

## Deployment
```bash
# Start Celery worker
celery -A src.p03_recovery.celery_app worker --loglevel=info

# Start FastAPI server
uvicorn src.p03_recovery.planner_api:app --reload
```

## Roadmap
- [ ] Интеграция с P0.2.6 Knowledge Base (RAG)
- [ ] Реализация Terraform/K8s API calls
- [ ] Добавление rollback mechanisms
- [ ] Мониторинг через Prometheus/Grafana
- [ ] Distributed execution на mesh-узлах
